#!/bin/bash

# Pre-push hook for claude-notify-script
# Runs actionlint and tests before pushing

set -e

echo "üîç Running pre-push checks..."

# Check if actionlint is installed
if command -v actionlint &> /dev/null; then
    echo "üìã Checking GitHub Actions workflows..."
    if ls .github/workflows/*.yml &> /dev/null 2>&1; then
        actionlint .github/workflows/*.yml
        echo "‚úÖ GitHub Actions workflows are valid"
    fi
else
    echo "‚ö†Ô∏è  actionlint not found, skipping workflow validation"
    echo "   Install with: brew install actionlint"
fi

# Check if bats is installed and run tests
if command -v bats &> /dev/null; then
    echo "üß™ Running tests..."
    export CLAUDE_TEST_MODE=true
    
    # Run bats tests
    if ls test/*.bats &> /dev/null 2>&1; then
        bats test/*.bats
        echo "‚úÖ All tests passed"
    fi
else
    echo "‚ö†Ô∏è  bats not found, skipping tests"
    echo "   Install with: brew install bats-core or npm install -g bats"
fi

# Run ShellCheck if available
if command -v shellcheck &> /dev/null; then
    echo "üîß Running ShellCheck..."
    find . -name "*.sh" -type f ! -path "./.git/*" ! -path "./test/*" -exec shellcheck {} \;
    echo "‚úÖ ShellCheck passed"
else
    echo "‚ö†Ô∏è  shellcheck not found, skipping shell script validation"
    echo "   Install with: brew install shellcheck"
fi

echo "‚ú® All pre-push checks passed!"